# MQTT Panel

ダークモード、ドラッグ&ドロップ並び替え、リアルタイムカラーコード監視機能を備えた、モダンな単一ファイルMQTTメッセージ処理アプリケーション。

![MQTT Panel Interface](https://img.shields.io/badge/Interface-Modern%20UI-blue)
![Single File](https://img.shields.io/badge/Architecture-Single%20HTML-green)
![No Build Required](https://img.shields.io/badge/Setup-No%20Build-orange)

## ✨ 機能

- 🎯 **単一HTMLファイル** - ビルド不要、1ファイルで完結するアプリケーション
- 🌓 **ダーク/ライトテーマ** - 設定を保存する自動テーマ切り替え
- 🎨 **28色パレット** - 視覚的なステータス表示のためのカスタム背景色・文字色
- 🔄 **ドラッグ&ドロップ並び替え** - 直感的なトピック整理
- ⚡ **リアルタイム更新** - 即座の視覚フィードバック付きライブMQTTメッセージ監視
- 📱 **レスポンシブデザイン** - デスクトップとモバイルでシームレスに動作
- 🔧 **MQTT機能** - 転送・変換・循環・スケジュール・タイマー操作と個別ON/OFF制御
- 🎛️ **インライン編集** - クリックでペイロードを編集して即座にパブリッシュ
- 🚀 **自動接続** - 起動時にMQTTへ自動接続
- 💾 **自動保存** - すべての設定をlocalStorageに自動保存
- 👁️ **モニターモード** - 機能を無効化してメッセージ処理なしで監視のみ実行
- 📺 **タイル表示** - 4:3比率に最適化されたグリッド表示とクリックパブリッシュ
- 🖥️ **フルスクリーンモード** - 専用コントロールバー付き没入型表示
- ⏰ **スケジューラー** - 曜日・時刻ベースの自動メッセージパブリッシュ
- ⏱️ **タイマー** - 音声アラートと時間超過追跡機能付きカウントダウンタイマー
- 📡 **クライアントステータス** - Willメッセージサポート付きオンライン/オフライン状態レポート
- 🔖 **リテインフラグ** - MQTTブローカーへのメッセージ永続化の設定可能
- 📝 **JSON Path** - ドット記法でJSONペイロードから値を抽出
- 🔤 **動的フォントサイズ** - タイルフォントサイズの設定とオーバーフロー自動処理

## 🚀 クイックスタート

1. `index.html` ファイルを**ダウンロード**
2. モダンなWebブラウザで**開く**
3. MQTTブローカー設定を**構成**
4. MQTTトピックの監視と制御を**開始**

インストール不要、依存関係なし、ビルド不要！

## 📋 ステップバイステップ設定

### 1. 初期設定

1. Webブラウザで`index.html`を開く
2. 右下の**設定ボタン**（⚙️）をクリック
3. **「MQTT Connection」**タブを選択
4. ブローカー情報を入力：
   - **Host**: MQTTブローカーのアドレス（例：`broker.example.com`）
   - **Port**: WebSocketポート（通常は`8083`）
   - **Username**: MQTTユーザー名（必要な場合）
   - **Password**: MQTTパスワード（必要な場合）
5. （オプション）**「Client Status」**タブでオンライン/オフラインレポート設定：
   - **Status Topic**: ステータスをパブリッシュするトピック（例：`client/status`）
   - **Online Payload**: 接続時のメッセージ（例：`online`）
   - **Away Payload**: 切断時のメッセージ（例：`offline`）
6. **「Connect」**をクリック

> 💡 設定が保存されている場合、次回以降は自動的に再接続します。
> 💡 クライアントステータスメッセージはリテインフラグ付きでパブリッシュされ、永続的なステータスとして保存されます。

### 2. トピックの追加

1. コントロールバーの**トピック追加ボタン**（➕）をクリック
2. 基本情報を入力：
   - **Label**: トピックの識別名
   - **Topic Name**: MQTTトピックパス（例：`home/sensors/temperature`）
   - **Show in Tile View**: タイル表示に表示するかどうかの切り替え
3. （オプション）構造化ペイロード用の**JSON Path**を設定：
   - **JSON Path for Value**: ペイロード値として抽出する要素（例：`data.status`）
   - **JSON Path for Display**: 表示テキストとして抽出する要素（例：`data.label`）

### 3. ペイロード値の設定

ペイロード値はコンパクトなテーブル形式で表示され、簡単に設定できます。

1. トピック設定ダイアログで**「Add Payload Value」**をクリック
2. 想定される各ペイロード値に対して：
   - **Payload Value**: 実際のMQTTペイロード（例：`"on"`, `"23.5"`）
   - **Display Text**: 人間が読める表示テキスト（例：`"ライトON"`, `"室温"`）
   - **BG**（背景色）: カラープレビューをクリックして28色から選択
   - **Text**（文字色）: 読みやすい文字色を選択
   - **Convert Value**: 変換機能で送信する値（オプション）

> 💡 タイマー機能とスケジュール機能ではペイロード値の設定は不要です

> 💡 **デフォルト色**: 1つ目のペイロードはティール/白（#20c997/#ffffff）、2つ目以降は赤/白（#ff0000/#ffffff）

### 4. 機能の設定

トピックごとに1つの機能タイプを選択：

#### 🔄 **転送機能（Transfer）**
- 受信したペイロードをそのまま別のトピックに転送
- **用途**: 異なるMQTTネットワーク間のブリッジ

#### 🔧 **変換機能（Convert）**
- ペイロード値を別の出力値にマッピング
- **用途**: センサー読み取り値をステータスメッセージに変換
- **例**: 温度`"25.0"` → ステータス`"快適"`

#### 🔁 **循環機能（Cycle）**
- トリガー受信時に定義済み値を順に循環
- **用途**: 多状態デバイスの制御（消灯 → 調光 → 点灯 → 消灯）
- **設定**:
  - **Next Payload**: 進むトリガー（例：`"next"`）
  - **Previous Payload**: 戻るトリガー（例：`"prev"`）

#### 📅 **スケジュール機能（Schedule）**
- 指定した時刻にメッセージをパブリッシュ
- **用途**: 自動照明制御、定期的なセンサーチェック
- **設定**:
  - トピックごとに最大2つの独立したスケジュール
  - 曜日選択（全選択/全解除ボタン付き）
  - 時刻指定（24時間形式）
  - パブリッシュするペイロード
  - スケジュールごとの個別有効/無効
- リテインフラグ付きでパブリッシュ

#### ⏱️ **タイマー機能（Timer）**
- 自動パブリッシュ付きカウントダウンタイマー
- **用途**: キッチンタイマー、灌漑制御、タイムアウト監視
- **動作**:
  - 整数（秒数）を受信するとカウントダウン開始
  - 設定した間隔で減少値をパブリッシュ
  - 数値以外のペイロードを受信すると停止
  - 0以下になると異なる色で時間超過を表示
- **表示**: HH:MM:SS形式（時が0の場合はMM:SS）
- **色の優先順位**: ペイロード値設定がタイマー色より優先
  - 特定の状態（例: "off", "0", "60"）にペイロード値を使用可能
  - ペイロード値が一致しない場合にタイマー色を適用
- **設定**:
  - パブリッシュ間隔（秒、デフォルト: 1）
  - カウントダウン中の色（背景/文字） - デフォルト: 青/白
  - 時間超過の色（背景/文字） - デフォルト: 赤/白
  - アラート音（Beep/Bell/Chime/カスタム音声ファイル）

### 5. 保存と監視

1. **「Save」**をクリックしてトピックを作成
2. メインテーブルでリアルタイム更新を確認
3. 現在のペイロード値に基づいて行の色が自動的に変化
4. **機能の切り替え**: 機能ボタンをクリックして処理の有効/無効を切り替え
   - **緑（ON）**: メッセージが処理され、機能が実行される
   - **グレー（OFF）**: メッセージは監視・表示のみ、処理なし

## 🎛️ インターフェースの使用方法

### 表示モード

#### リスト表示
- 全トピック詳細を表示する従来のテーブルレイアウト
- **🖱️ ペイロードセルをクリック**: 値を編集して即座にパブリッシュ
- **🖱️ 行を右クリック**: コンテキストメニューで編集/複製/削除/クイックパブリッシュ
- **🖱️ グリップハンドルをドラッグ**: ≡ アイコンをドラッグしてトピックを並び替え
- **🖱️ 機能ボタンをクリック**: 機能実行のON/OFF切り替え（監視は継続）
- **🖱️ トピックを複製**: 右クリックして「Duplicate」を選択すると複製を作成

#### タイル表示
- 4:3比率に最適化されたグリッドレイアウト
- ラベルと表示テキストのみを表示
- **🖱️ タイルをクリック**: 次のペイロード値をパブリッシュ（値を循環）
- 最適なグリッドサイズを自動計算
- トピックごとの表示/非表示制御
- タイルサイズに基づく動的フォントサイズ
- テキストオーバーフロー自動処理（フォント縮小、収まらない場合は「...」表示）

### コントロールバー（右側）

- **🖥️ フルスクリーン**: フルスクリーンモードの切り替え
- **🌓 テーマ**: ダーク/ライトテーマの切り替え
- **📊 表示**: リスト表示とタイル表示の切り替え
- **⚙️ 設定**: 設定モーダルを開く
- **➕ トピック追加**: 新規トピックを作成
- **📁 GitHub**: リポジトリリンク（下部）

### ステータスインジケーター

- **🟢 右上角**: MQTTブローカーに接続中
- **🔴 右上角**: ブローカーから切断中
- **機能ボタン**（リスト表示）:
  - **緑（ON）**: 機能アクティブ - メッセージを処理・転送
  - **グレー（OFF）**: 機能非アクティブ - 監視のみ、処理なし

## 🔧 設定例

### スマートライト制御（循環機能）

```
ラベル: リビングルームライト
トピック: home/living-room/light
機能: Cycle

ペイロード値:
- "off" → 表示: "消灯" → 背景: ライトレッド
- "dim" → 表示: "調光" → 背景: ライトイエロー
- "bright" → 表示: "点灯" → 背景: ライトグリーン

進むペイロード: "button_press"
戻るペイロード: "long_press"
```

**動作**: ボタン押下ごとに循環: 消灯 → 調光 → 点灯 → 消灯

**機能制御**: 機能ボタンをOFFにすることで、ライトの状態を監視しながら循環動作を無効化できます。

### 温度モニター（変換機能）

```
ラベル: 室温
トピック: sensors/temperature
機能: Convert
ターゲットトピック: home/status/comfort

ペイロード値:
- "18.0" → 表示: "寒い" → 変換: "heat_on"
- "22.0" → 表示: "快適" → 変換: "auto"
- "28.0" → 表示: "暑い" → 変換: "cool_on"

デフォルト値: "unknown"
```

**動作**: 温度読み取り値がHVACコマンドをトリガー

**機能制御**: 機能を無効化することで、HVAC制御コマンドを送信せずに温度監視のみ実行できます。

### センサーブリッジ（転送機能）

```
ラベル: モーションセンサー
トピック: zigbee/motion/sensor1
機能: Transfer
ターゲットトピック: home-assistant/binary_sensor/motion1

ペイロード値:
- "true" → 表示: "動作検知" → 背景: オレンジ
- "false" → 表示: "動作なし" → 背景: ライトグレー
```

**動作**: MQTTシステム間でモーションイベントを転送

**機能制御**: 転送をOFFにしながら、モーション検知状態の監視を継続できます。

### JSONペイロード抽出

```
ラベル: IoTセンサー
トピック: sensors/device1
JSON Path for Value: data.status
JSON Path for Display: data.label

ペイロード値:
- "active" → 表示: "アクティブ" → 背景: グリーン
- "idle" → 表示: "アイドル" → 背景: グレー
```

**JSONペイロード例**:
```json
{"data": {"status": "active", "label": "センサーオンライン", "temp": 25.5}}
```

**動作**: `data.status`（"active"）をペイロード値として抽出して色のマッチングに使用し、`data.label`（"センサーオンライン"）を表示テキストとして抽出します。

## 🔖 リテインフラグ

異なる操作によってリテインフラグの動作が異なり、MQTTブローカーへのメッセージ永続化を制御します：

### ✅ ブローカーに保存されるメッセージ
- **循環機能（Cycle）**: パブリッシュされた値は保持される
- **スケジュール機能（Schedule）**: パブリッシュされた値は保持される
- **タイル表示クリック**: パブリッシュされた値は保持される
- **クイックパブリッシュ**（コンテキストメニュー）: パブリッシュされた値は保持される
- **インラインペイロード編集**: パブリッシュされた値は保持される
- **クライアントステータス**: オンラインメッセージとオフラインメッセージの両方が保持される

### 🔄 受信メッセージに従う
- **転送機能（Transfer）**: 受信したメッセージのリテインフラグを使用
- **変換機能（Convert）**: 受信したメッセージのリテインフラグを使用

### ❌ 保存されないメッセージ
- **タイマー機能（Timer）**: カウントダウン値は保持されない（一時的な状態）

## 📊 データ管理

### 設定のエクスポート
1. **Settings** → **「Data Management」**タブ
2. **「Export」**をクリック
3. JSON設定をコピー
4. バックアップ用にファイルに保存

### 設定のインポート
1. **Settings** → **「Data Management」**タブ
2. テキストエリアにJSON設定を貼り付け
3. **「Import」**をクリック
4. 設定が自動的に適用される

### バックアップ戦略
- 設定を定期的にエクスポートして保存
- JSONファイルをバージョン管理に保存
- チームメンバー間で設定を共有

### フォントサイズ設定
1. **Settings** → **「Font Size」**タブ
2. タイル表示のフォントサイズを設定：
   - **Label Font Size (%)**: ラベルテキストのタイルサイズに対する割合（デフォルト: 18%）
   - **Display Font Size (%)**: 表示テキストのタイルサイズに対する割合（デフォルト: 14%）
3. 範囲: 5% ～ 50%
4. 変更は即座にタイル表示に適用

## 🔗 MQTTブローカー設定

### パブリックテストブローカー
- `broker.mqttdashboard.com:8000` (WebSocket)
- `test.mosquitto.org:8080` (WebSocket)

### ローカルMosquitto設定
```bash
# Mosquittoのインストール
sudo apt install mosquitto mosquitto-clients

# /etc/mosquitto/mosquitto.confでWebSocketリスナーを有効化
listener 8083
protocol websockets

# サービスの再起動
sudo systemctl restart mosquitto
```

### Docker設定
```bash
docker run -it -p 1883:1883 -p 8083:8083 \
  -v mosquitto.conf:/mosquitto/config/mosquitto.conf \
  eclipse-mosquitto
```

## 🌐 ブラウザ互換性

- ✅ Chrome 88+
- ✅ Firefox 85+
- ✅ Safari 14+
- ✅ Edge 88+

**必要な機能**:
- WebSocketサポート
- Drag & Drop API
- CSSカスタムプロパティ
- localStorage API

## 🔧 トラブルシューティング

### 接続の問題
- ✅ WebSocketポートを確認（通常8083、1883ではない）
- ✅ ブローカーがWebSocketプロトコルをサポートしているか確認
- ✅ ファイアウォールとネットワーク接続を確認
- ✅ まずユーザー名/パスワードなしで試す

### 色が表示されない
- ✅ ペイロード値が正確に一致しているか確認（大文字小文字を区別）
- ✅ トピック設定でペイロード値が設定されているか確認
- ✅ MQTTメッセージが受信されているか確認

### ドラッグ&ドロップが動作しない
- ✅ 左側のグリップハンドル（≡）アイコンを使用
- ✅ ブラウザがDrag & Drop APIをサポートしているか確認
- ✅ ページをリフレッシュしてみる

### テーマが保存されない
- ✅ localStorageが有効になっているか確認
- ✅ ブラウザがfile://URLでローカルストレージを許可しているか確認
- ✅ 必要に応じてhttp://localhostで開いてみる

## 🤝 貢献

これはシンプルさのための単一ファイルアプリケーションです。貢献する際は：

1. **単一ファイルアーキテクチャを維持**
2. **複数のブラウザでテスト**
3. **ライトとダークの両テーマで動作確認**
4. **データ形式の後方互換性を維持**
5. **CLAUDE.mdドキュメントを更新**

## 📄 ライセンス

MIT License - 自由に使用、変更、配布できます。

## 🔗 リンク

- **リポジトリ**: https://github.com/ytx/mqtt_p
- **Issues**: https://github.com/ytx/mqtt_p/issues
- **MQTT.jsドキュメント**: https://github.com/mqttjs/MQTT.js
- **Bootstrapドキュメント**: https://getbootstrap.com/docs/5.3/

---

**MQTTコミュニティのために ❤️ を込めて作成**