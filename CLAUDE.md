# MQTT Patcher

単一HTMLファイルで動作するMQTTメッセージ処理アプリケーション

## 概要

MQTT Patcherは、MQTTトピックを監視し、受信したメッセージに対して転送・変換・循環などの処理を行うWebアプリケーションです。設定したトピックを一覧表示し、リアルタイムでメッセージの状態を確認できます。

## 主な機能

### トピック管理
- **一覧表示**: トピックをテーブル形式で表示
  - ラベル: 任意の識別名
  - 表示: ペイロード値に対応する表示文字列
  - トピック: MQTTトピック名
  - ペイロード: 現在のペイロード値
  - 機能: 設定された機能のON/OFF状態

- **CRUD操作**:
  - 新規登録: 右上の「新規登録」ボタン
  - 編集・削除: 行を右クリックしてコンテキストメニューから選択

### 処理機能（排他選択）

#### 1. 転送機能
- 受信したペイロードをそのまま別のトピックにパブリッシュ
- 設定項目: 転送先トピック

#### 2. 変換機能
- 受信したペイロードに対応する値を別のトピックにパブリッシュ
- ペイロード値ごとに変換値を設定可能
- 設定項目: 変換先トピック、デフォルト値（未定義ペイロード用）

#### 3. 循環機能
- 特定のペイロード（進む・戻る）を受信すると、設定された値のリストを順に進める・戻す
- リテイン付きでパブリッシュ（MQTTサーバに保存）
- 初期値がない場合は最初の要素を使用
- 設定項目: 進むペイロード（必須）、戻るペイロード（任意）

### 表示設定
- **ペイロード値設定**: 各ペイロード値に対して
  - 表示文字列: 一覧での表示名
  - 行色: テーブル行の背景色
  - 変換値: 変換機能で使用する値

### MQTT接続
- **接続設定**: ホスト、ポート、ユーザー名、パスワード
- **自動購読**: 設定されたトピックを自動的に購読
- **接続状態表示**: ヘッダーの状態インジケーター

### データ管理
- **自動保存**: LocalStorageに設定を保存
- **エクスポート**: 全設定をJSON形式でテキストエリアに表示
- **インポート**: JSON形式の設定データを読み込み

## 技術仕様

### ファイル構成
- `index.html`: 単一ファイルアプリケーション（HTML/CSS/JavaScript）

### 使用ライブラリ（CDN）
- Bootstrap 5.3.0: UIフレームワーク
- Bootstrap Icons: アイコン
- MQTT.js: MQTTクライアント

### 動作要件
- モダンWebブラウザ（WebSocket対応）
- MQTTブローカー（WebSocket対応）

## 使用方法

### 1. 初期設定
1. `index.html`をブラウザで開く
2. 「設定」ボタンから「MQTT接続」タブでブローカー情報を入力
3. 「接続」ボタンでMQTTブローカーに接続

### 2. トピック設定
1. 「新規登録」ボタンでトピック設定画面を開く
2. 基本情報（ラベル、トピック名）を入力
3. ペイロード値設定で取り得る値と表示情報を登録
4. 機能設定で転送・変換・循環のいずれかを選択・設定
5. 「保存」で設定完了

### 3. 動作確認
- 一覧画面でリアルタイムにメッセージ受信を確認
- 機能列のボタンでON/OFF切替
- 右クリックメニューで編集・削除

### 4. データ管理
- 「設定」→「データ管理」でエクスポート/インポート
- JSON形式で設定の共有・バックアップが可能

## 設定例

### 循環機能の例
```
ラベル: ライト制御
トピック: home/light/status
ペイロード値:
- value: "off", display: "消灯", color: "#ffcccc"
- value: "dim", display: "調光", color: "#ffffcc"
- value: "bright", display: "点灯", color: "#ccffcc"
機能: 循環
進むペイロード: "next"
戻るペイロード: "prev"
```

現在値が"dim"の時に"next"を受信すると"bright"をパブリッシュします。

## データ形式

設定データはLocalStorageに以下の形式で保存されます：

```json
{
  "topics": [
    {
      "label": "トピック名",
      "name": "mqtt/topic",
      "functionType": "cycle",
      "functionEnabled": true,
      "payloadValues": [
        {
          "value": "on",
          "display": "オン",
          "color": "#ccffcc",
          "convertValue": "1"
        }
      ],
      "cycleNextPayload": "next",
      "cyclePrevPayload": "prev"
    }
  ],
  "settings": {
    "mqttHost": "broker.example.com",
    "mqttPort": "8083",
    "mqttUsername": "user",
    "mqttPassword": "pass"
  }
}
```