<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .topic-row {
            cursor: pointer;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            box-shadow: 0 0 3px rgba(0,0,0,0.3);
        }
        .status-connected {
            background-color: #28a745;
        }
        .status-disconnected {
            background-color: #dc3545;
        }
        .function-toggle {
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        .function-active {
            background-color: #28a745;
            color: white;
        }
        .function-inactive {
            background-color: #6c757d;
            color: white;
        }
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 120px;
        }
        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .context-menu-item:hover {
            background-color: #f8f9fa;
        }
        .context-menu-item:last-child {
            border-bottom: none;
        }
        .color-palette {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 5px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            border: 2px solid #ddd;
            cursor: pointer;
            position: relative;
        }
        .color-option:hover {
            border-color: #007bff;
            transform: scale(1.1);
        }
        .color-option.selected {
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0,123,255,0.5);
        }
        .color-option::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: none;
        }
        .color-option.selected::after {
            display: block;
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.3);
        }
        .color-preview {
            transition: all 0.2s ease;
        }
        .color-preview:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .color-palette-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .color-palette-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
        }

        /* Override Bootstrap table colors with high specificity */
        .table.table-striped > tbody > tr.topic-row-colored {
            --bs-table-bg: var(--row-bg-color) !important;
            --bs-table-color: var(--row-text-color) !important;
            background-color: var(--row-bg-color) !important;
            background: var(--row-bg-color) !important;
            color: var(--row-text-color) !important;
        }

        .table.table-striped > tbody > tr.topic-row-colored > td {
            --bs-table-bg: var(--row-bg-color) !important;
            --bs-table-color: var(--row-text-color) !important;
            background-color: var(--row-bg-color) !important;
            background: var(--row-bg-color) !important;
            color: var(--row-text-color) !important;
        }

        .table.table-striped > tbody > tr.topic-row-colored:nth-of-type(odd) {
            --bs-table-striped-bg: var(--row-bg-color) !important;
            background-color: var(--row-bg-color) !important;
            background: var(--row-bg-color) !important;
        }

        .table.table-striped > tbody > tr.topic-row-colored:nth-of-type(odd) > td {
            --bs-table-bg: var(--row-bg-color) !important;
            --bs-table-color: var(--row-text-color) !important;
            --bs-table-striped-bg: var(--row-bg-color) !important;
            background-color: var(--row-bg-color) !important;
            background: var(--row-bg-color) !important;
            color: var(--row-text-color) !important;
        }

        /* Dark mode overrides for colored rows */
        [data-theme="dark"] .table > :not(caption) > * > tr.topic-row-colored > * {
            background-color: var(--row-bg-color) !important;
            color: var(--row-text-color) !important;
        }

        /* Additional dark mode row color overrides */
        [data-theme="dark"] .table.table-striped > tbody > tr.topic-row-colored {
            --bs-table-bg: var(--row-bg-color) !important;
            --bs-table-color: var(--row-text-color) !important;
            background-color: var(--row-bg-color) !important;
            background: var(--row-bg-color) !important;
            color: var(--row-text-color) !important;
        }

        [data-theme="dark"] .table.table-striped > tbody > tr.topic-row-colored > td {
            --bs-table-bg: var(--row-bg-color) !important;
            --bs-table-color: var(--row-text-color) !important;
            background-color: var(--row-bg-color) !important;
            background: var(--row-bg-color) !important;
            color: var(--row-text-color) !important;
        }

        [data-theme="dark"] .table.table-striped > tbody > tr.topic-row-colored:nth-of-type(odd) {
            --bs-table-striped-bg: var(--row-bg-color) !important;
            background-color: var(--row-bg-color) !important;
            background: var(--row-bg-color) !important;
        }

        [data-theme="dark"] .table.table-striped > tbody > tr.topic-row-colored:nth-of-type(odd) > td {
            --bs-table-bg: var(--row-bg-color) !important;
            --bs-table-color: var(--row-text-color) !important;
            --bs-table-striped-bg: var(--row-bg-color) !important;
            background-color: var(--row-bg-color) !important;
            background: var(--row-bg-color) !important;
            color: var(--row-text-color) !important;
        }

        /* Payload editing styles */
        .payload-cell {
            cursor: pointer;
            position: relative;
        }

        /* Payload cell hover effect disabled */
        /* .payload-cell:hover {
            background-color: rgba(0, 123, 255, 0.1) !important;
        } */

        .payload-edit-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: white;
            border: 2px solid #007bff;
            border-radius: 4px;
            padding: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .payload-edit-input {
            width: 100%;
            border: none;
            outline: none;
            background: transparent;
            font-size: inherit;
            font-family: inherit;
        }

        .payload-edit-select {
            width: 100%;
            border: none;
            outline: none;
            background: white;
            font-size: inherit;
            font-family: inherit;
            margin-bottom: 5px;
        }

        .payload-edit-buttons {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .payload-edit-btn {
            padding: 2px 8px;
            font-size: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 3px;
            cursor: pointer;
            background: white;
        }

        .payload-edit-btn.save {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .payload-edit-btn.cancel {
            background: #6c757d;
            color: white;
            border-color: #6c757d;
        }

        /* Floating action buttons */
        .fab {
            position: fixed;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            text-decoration: none;
            transition: all 0.3s ease;
            background: transparent;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            text-decoration: none;
        }

        .fab-add {
            position: fixed;
            top: 20px;
            right: 20px;
            color: #007bff;
        }

        .fab-add:hover {
            background: rgba(0, 123, 255, 0.1);
            color: #0056b3;
        }

        .fab-view-toggle {
            bottom: 20px;
            right: 160px;
            color: #17a2b8;
        }

        .fab-view-toggle:hover {
            background: rgba(23, 162, 184, 0.1);
            color: #117a8b;
        }

        .fab-theme {
            bottom: 20px;
            right: 90px;
            color: #ffc107;
        }

        .fab-theme:hover {
            background: rgba(255, 193, 7, 0.1);
            color: #e0a800;
        }

        .fab-settings {
            bottom: 20px;
            right: 20px;
            color: #6c757d;
        }

        .fab-settings:hover {
            background: rgba(108, 117, 125, 0.1);
            color: #495057;
        }

        .fab-github {
            bottom: 20px;
            left: 20px;
            color: #333;
        }

        .fab-github:hover {
            background: rgba(51, 51, 51, 0.1);
            color: #000;
        }

        /* Tile view styles */
        #tileView {
            display: none;
            padding: 10px;
            gap: 15px;
            height: calc(100vh - 20px);
            width: calc(100% - 60px);
        }

        .tile {
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            min-height: 0;
        }

        /* Tile hover effect disabled */
        /* .tile:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        } */

        .tile-label {
            font-weight: bold;
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        .tile-display {
            font-size: 1.1em;
        }

        /* Tile mode control bar */
        #tileControlBar {
            display: none;
            position: fixed;
            right: 0;
            top: 0;
            width: 50px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            border-left: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
        }

        [data-theme="dark"] #tileControlBar {
            background: rgba(30, 30, 30, 0.95);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }

        #tileControlBar.disconnected {
            background: rgba(255, 100, 100, 0.95);
        }

        [data-theme="dark"] #tileControlBar.disconnected {
            background: rgba(150, 30, 30, 0.95);
        }

        .tile-control-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: #6c757d;
            font-size: 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }

        .tile-control-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #007bff;
            transform: scale(1.1);
        }

        [data-theme="dark"] .tile-control-btn {
            color: #adb5bd;
        }

        [data-theme="dark"] .tile-control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #17a2b8;
        }

        .tile-control-spacer {
            flex: 1;
        }

        .tile-control-github {
            color: #6c757d;
            text-decoration: none;
            font-size: 20px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .tile-control-github:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #333;
            transform: scale(1.1);
        }

        [data-theme="dark"] .tile-control-github {
            color: #adb5bd;
        }

        [data-theme="dark"] .tile-control-github:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
        }

        /* Drag and Drop styles */
        .topic-row {
            transition: all 0.2s ease;
        }

        .topic-row.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            z-index: 1000;
        }

        .topic-row.drag-over {
            border-top: 3px solid #007bff;
        }

        .drag-handle {
            cursor: grab;
            color: #6c757d;
            padding: 0 8px;
        }

        .drag-handle:hover {
            color: #007bff;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        /* Dark mode styles */
        [data-theme="dark"] {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }

        [data-theme="dark"] .table {
            --bs-table-bg: #2d2d2d;
            --bs-table-striped-bg: #343434;
            --bs-table-hover-bg: #3a3a3a;
            --bs-table-color: #e0e0e0;
            background-color: #2d2d2d !important;
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] .table td,
        [data-theme="dark"] .table th {
            color: #e0e0e0 !important;
            border-color: #444 !important;
        }

        [data-theme="dark"] .table > :not(caption) > * > *:not(.topic-row-colored *) {
            background-color: var(--bs-table-bg) !important;
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] .table-dark {
            --bs-table-bg: #1f1f1f !important;
            --bs-table-border-color: #444 !important;
            --bs-table-color: #e0e0e0 !important;
            background-color: #1f1f1f !important;
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] .table-dark td,
        [data-theme="dark"] .table-dark th {
            background-color: #1f1f1f !important;
            color: #e0e0e0 !important;
            border-color: #444 !important;
        }

        [data-theme="dark"] .modal-content {
            background-color: #2d2d2d;
            color: #e0e0e0;
            border: 1px solid #444;
        }

        [data-theme="dark"] .form-control {
            background-color: #3a3a3a;
            border-color: #555;
            color: #e0e0e0;
        }

        [data-theme="dark"] .form-control:focus {
            background-color: #3a3a3a;
            border-color: #007bff;
            color: #e0e0e0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        [data-theme="dark"] .form-select {
            background-color: #3a3a3a;
            border-color: #555;
            color: #e0e0e0;
        }

        [data-theme="dark"] .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        [data-theme="dark"] .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }

        [data-theme="dark"] .btn-outline-primary {
            color: #0d6efd;
            border-color: #0d6efd;
        }

        [data-theme="dark"] .btn-outline-primary:hover {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: #fff;
        }

        [data-theme="dark"] .context-menu {
            background: #2d2d2d;
            border-color: #555;
            color: #e0e0e0;
        }

        [data-theme="dark"] .context-menu-item:hover {
            background-color: #3a3a3a;
        }

        [data-theme="dark"] .payload-edit-container {
            background: #2d2d2d;
            border-color: #007bff;
        }

        [data-theme="dark"] .color-palette-container {
            background: #2d2d2d;
            color: #e0e0e0;
        }

        [data-theme="dark"] .nav-tabs .nav-link {
            color: #adb5bd;
            background-color: transparent;
            border-color: #555;
        }

        [data-theme="dark"] .nav-tabs .nav-link.active {
            color: #e0e0e0;
            background-color: #2d2d2d;
            border-color: #555 #555 #2d2d2d;
        }

        [data-theme="dark"] .fab {
            border-color: rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .container-fluid {
            background-color: #1a1a1a;
        }

        [data-theme="dark"] .function-toggle {
            background-color: #3a3a3a !important;
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] .function-active {
            background-color: #28a745 !important;
            color: white !important;
        }

        [data-theme="dark"] .function-inactive {
            background-color: #6c757d !important;
            color: white !important;
        }

        /* Dark mode payload cell hover effect disabled */
        /* [data-theme="dark"] .payload-cell:hover {
            background-color: rgba(0, 123, 255, 0.2) !important;
        } */

        [data-theme="dark"] .topic-row.drag-over {
            border-top-color: #007bff !important;
        }

        [data-theme="dark"] .drag-handle {
            color: #adb5bd;
        }

        [data-theme="dark"] .drag-handle:hover {
            color: #007bff;
        }

        /* Dark mode title and headers */
        [data-theme="dark"] h1,
        [data-theme="dark"] h2,
        [data-theme="dark"] h3,
        [data-theme="dark"] h4,
        [data-theme="dark"] h5,
        [data-theme="dark"] h6 {
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] .modal-title {
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] .form-label {
            color: #e0e0e0 !important;
        }

        /* Theme toggle button */
        .fab-theme {
            bottom: 20px;
            right: 90px;
            color: #ffc107;
        }

        .fab-theme:hover {
            background: rgba(255, 193, 7, 0.1);
            color: #ffb300;
        }
    </style>
</head>
<body>
    <!-- Status indicator -->
    <span class="status-indicator status-disconnected" id="connectionStatus"></span>

    <div class="container-fluid mt-3" style="padding-right: 60px;">
        <!-- Header -->
        <div class="row mb-3" id="pageHeader">
            <div class="col">
                <h2 style="margin-left: 20px;">MQTT Panel</h2>
            </div>
            <div class="col-auto">
                <!-- Buttons moved to floating action buttons -->
            </div>
        </div>

        <!-- Topic List Table -->
        <div class="row" id="listView">
            <div class="col">
                <table class="table table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th width="30"></th>
                            <th>Label</th>
                            <th>Display</th>
                            <th>Topic</th>
                            <th>Payload</th>
                            <th>Function</th>
                        </tr>
                    </thead>
                    <tbody id="topicTableBody">
                        <!-- Topics will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tile View -->
        <div id="tileView">
            <!-- Tiles will be inserted here -->
        </div>
    </div>

    <!-- Control Bar -->
    <div id="tileControlBar">
        <button class="tile-control-btn" id="fullscreenBtn" title="Toggle Fullscreen">
            <i class="bi bi-fullscreen" id="fullscreenIcon"></i>
        </button>
        <button class="tile-control-btn" id="tileThemeBtn" title="Toggle Theme">
            <i class="bi bi-sun" id="tileThemeIcon"></i>
        </button>
        <button class="tile-control-btn" id="tileViewBtn" title="Toggle View">
            <i class="bi bi-grid-3x3-gap"></i>
        </button>
        <button class="tile-control-btn" id="tileSettingsBtn" title="Settings">
            <i class="bi bi-gear"></i>
        </button>
        <button class="tile-control-btn" id="tileAddBtn" title="Add Topic">
            <i class="bi bi-plus"></i>
        </button>
        <div class="tile-control-spacer"></div>
        <a href="https://github.com/ytx/mqtt_p" target="_blank" class="tile-control-github" title="GitHub">
            <i class="bi bi-github"></i>
        </a>
    </div>

    <!-- Floating Action Buttons -->
    <button class="fab fab-add" id="addTopicBtn" title="Add Topic">
        <i class="bi bi-plus"></i>
    </button>

    <button class="fab fab-view-toggle" id="viewToggle" title="Toggle View" style="display: none;">
        <i class="bi bi-grid-3x3-gap" id="viewIcon"></i>
    </button>

    <button class="fab fab-theme" id="themeBtn" title="Toggle Theme">
        <i class="bi bi-sun" id="themeIcon"></i>
    </button>

    <button class="fab fab-settings" id="settingsBtn" title="Settings">
        <i class="bi bi-gear"></i>
    </button>

    <a href="https://github.com/ytx/mqtt_p" target="_blank" class="fab fab-github" title="GitHub">
        <i class="bi bi-github"></i>
    </a>

    <!-- Context Menu -->
    <div class="context-menu d-none" id="contextMenu">
        <div id="payloadMenuItems"></div>
        <div class="context-menu-item" id="editTopic">Edit</div>
        <div class="context-menu-item" id="duplicateTopic">Duplicate</div>
        <div class="context-menu-item" id="deleteTopic">Delete</div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="settingsTabs">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#mqttTab">MQTT Connection</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#clientStatusTab">Client Status</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#dataTab">Data Management</a>
                        </li>
                    </ul>
                    <div class="tab-content mt-3">
                        <div class="tab-pane fade show active" id="mqttTab">
                            <form id="mqttSettingsForm">
                                <div class="mb-3">
                                    <label for="mqttHost" class="form-label">Host</label>
                                    <input type="text" class="form-control" id="mqttHost" placeholder="broker.example.com">
                                </div>
                                <div class="mb-3">
                                    <label for="mqttPort" class="form-label">Port</label>
                                    <input type="number" class="form-control" id="mqttPort" value="8083">
                                </div>
                                <div class="mb-3">
                                    <label for="mqttUsername" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="mqttUsername">
                                </div>
                                <div class="mb-3">
                                    <label for="mqttPassword" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="mqttPassword">
                                </div>
                                <button type="button" class="btn btn-primary" id="connectBtn">Connect</button>
                                <button type="button" class="btn btn-secondary" id="disconnectBtn">Disconnect</button>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="clientStatusTab">
                            <form id="clientStatusForm">
                                <div class="mb-3">
                                    <label for="statusTopic" class="form-label">Status Topic</label>
                                    <input type="text" class="form-control" id="statusTopic" value="clients/client_name">
                                </div>
                                <div class="mb-3">
                                    <label for="onlinePayload" class="form-label">Online Payload</label>
                                    <input type="text" class="form-control" id="onlinePayload" value="online">
                                </div>
                                <div class="mb-3">
                                    <label for="awayPayload" class="form-label">Away Payload</label>
                                    <input type="text" class="form-control" id="awayPayload" value="away">
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="dataTab">
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-primary" id="exportBtn">Export</button>
                                <button type="button" class="btn btn-outline-success" id="importBtn">Import</button>
                            </div>
                            <div class="mb-3">
                                <label for="dataTextArea" class="form-label">Configuration Data</label>
                                <textarea class="form-control" id="dataTextArea" rows="10"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveSettingsBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Topic Configuration Modal -->
    <div class="modal fade" id="topicModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="topicModalTitle">Topic Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="topicForm">
                        <div class="row mb-3">
                            <div class="col-md-5">
                                <label for="topicLabel" class="form-label">Label</label>
                                <input type="text" class="form-control" id="topicLabel" required>
                            </div>
                            <div class="col-md-5">
                                <label for="topicName" class="form-label">Topic Name</label>
                                <input type="text" class="form-control" id="topicName" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Display Options</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="showInTileView" checked>
                                    <label class="form-check-label" for="showInTileView">Show in Tile View</label>
                                </div>
                            </div>
                        </div>

                        <!-- Payload Values Section -->
                        <div class="mb-4">
                            <h6>Payload Value Settings</h6>
                            <div class="mb-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" id="addPayloadBtn">
                                    <i class="bi bi-plus"></i> Add Payload Value
                                </button>
                            </div>
                            <div id="payloadValues">
                                <!-- Payload value entries will be inserted here -->
                            </div>
                        </div>

                        <!-- Function Settings Section -->
                        <div class="mb-4">
                            <h6>Function Settings</h6>
                            <div class="mb-3">
                                <select class="form-select" id="functionType">
                                    <option value="">No Function</option>
                                    <option value="transfer">Transfer</option>
                                    <option value="convert">Convert</option>
                                    <option value="cycle">Cycle</option>
                                    <option value="schedule">Schedule</option>
                                    <option value="timer">Timer</option>
                                </select>
                            </div>

                            <!-- Transfer Settings -->
                            <div id="transferSettings" class="d-none">
                                <div class="mb-3">
                                    <label for="transferTopic" class="form-label">Target Topic</label>
                                    <input type="text" class="form-control" id="transferTopic">
                                </div>
                            </div>

                            <!-- Convert Settings -->
                            <div id="convertSettings" class="d-none">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="convertTopic" class="form-label">Target Topic</label>
                                        <input type="text" class="form-control" id="convertTopic">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="convertDefault" class="form-label">Default Value</label>
                                        <input type="text" class="form-control" id="convertDefault">
                                    </div>
                                </div>
                            </div>

                            <!-- Cycle Settings -->
                            <div id="cycleSettings" class="d-none">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="cycleNextPayload" class="form-label">Next Payload</label>
                                        <input type="text" class="form-control" id="cycleNextPayload">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="cyclePrevPayload" class="form-label">Previous Payload (Optional)</label>
                                        <input type="text" class="form-control" id="cyclePrevPayload">
                                    </div>
                                </div>
                            </div>

                            <!-- Schedule Settings -->
                            <div id="scheduleSettings" class="d-none">
                                <!-- Schedule 1 -->
                                <div class="border p-3 mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0">Schedule 1</h6>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="schedule1Enabled" checked>
                                            <label class="form-check-label" for="schedule1Enabled">Enabled</label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label mb-0">Days of Week</label>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-secondary" onclick="selectAllDays('schedule1')">All</button>
                                                <button type="button" class="btn btn-outline-secondary" onclick="deselectAllDays('schedule1')">None</button>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <div class="form-check">
                                                <input class="form-check-input schedule1-day" type="checkbox" value="0" id="schedule1Sun">
                                                <label class="form-check-label" for="schedule1Sun">Sun</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input schedule1-day" type="checkbox" value="1" id="schedule1Mon">
                                                <label class="form-check-label" for="schedule1Mon">Mon</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input schedule1-day" type="checkbox" value="2" id="schedule1Tue">
                                                <label class="form-check-label" for="schedule1Tue">Tue</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input schedule1-day" type="checkbox" value="3" id="schedule1Wed">
                                                <label class="form-check-label" for="schedule1Wed">Wed</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input schedule1-day" type="checkbox" value="4" id="schedule1Thu">
                                                <label class="form-check-label" for="schedule1Thu">Thu</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input schedule1-day" type="checkbox" value="5" id="schedule1Fri">
                                                <label class="form-check-label" for="schedule1Fri">Fri</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input schedule1-day" type="checkbox" value="6" id="schedule1Sat">
                                                <label class="form-check-label" for="schedule1Sat">Sat</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="schedule1Time" class="form-label">Time</label>
                                            <input type="time" class="form-control" id="schedule1Time">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="schedule1Payload" class="form-label">Payload</label>
                                            <input type="text" class="form-control" id="schedule1Payload">
                                        </div>
                                    </div>
                                </div>

                                <!-- Schedule 2 -->
                                <div class="border p-3">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0">Schedule 2</h6>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="schedule2Enabled" checked>
                                            <label class="form-check-label" for="schedule2Enabled">Enabled</label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label mb-0">Days of Week</label>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-secondary" onclick="selectAllDays('schedule2')">All</button>
                                                <button type="button" class="btn btn-outline-secondary" onclick="deselectAllDays('schedule2')">None</button>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <div class="form-check">
                                                <input class="form-check-input schedule2-day" type="checkbox" value="0" id="schedule2Sun">
                                                <label class="form-check-label" for="schedule2Sun">Sun</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input schedule2-day" type="checkbox" value="1" id="schedule2Mon">
                                                <label class="form-check-label" for="schedule2Mon">Mon</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input schedule2-day" type="checkbox" value="2" id="schedule2Tue">
                                                <label class="form-check-label" for="schedule2Tue">Tue</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input schedule2-day" type="checkbox" value="3" id="schedule2Wed">
                                                <label class="form-check-label" for="schedule2Wed">Wed</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input schedule2-day" type="checkbox" value="4" id="schedule2Thu">
                                                <label class="form-check-label" for="schedule2Thu">Thu</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input schedule2-day" type="checkbox" value="5" id="schedule2Fri">
                                                <label class="form-check-label" for="schedule2Fri">Fri</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input schedule2-day" type="checkbox" value="6" id="schedule2Sat">
                                                <label class="form-check-label" for="schedule2Sat">Sat</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="schedule2Time" class="form-label">Time</label>
                                            <input type="time" class="form-control" id="schedule2Time">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="schedule2Payload" class="form-label">Payload</label>
                                            <input type="text" class="form-control" id="schedule2Payload">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Timer Settings -->
                            <div id="timerSettings" class="d-none">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="timerInterval" class="form-label">Publish Interval (seconds)</label>
                                        <input type="number" class="form-control" id="timerInterval" value="1" min="1">
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Countdown Color</label>
                                        <div class="row">
                                            <div class="col-6">
                                                <label class="form-label small">Background</label>
                                                <div class="d-flex align-items-center">
                                                    <div style="width: 40px; height: 40px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" id="timerCountdownBgPreview"></div>
                                                    <input type="hidden" id="timerCountdownBg" value="#007bff">
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label small">Text</label>
                                                <div class="d-flex align-items-center">
                                                    <div style="width: 40px; height: 40px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" id="timerCountdownFgPreview"></div>
                                                    <input type="hidden" id="timerCountdownFg" value="#ffffff">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Overtime Color</label>
                                        <div class="row">
                                            <div class="col-6">
                                                <label class="form-label small">Background</label>
                                                <div class="d-flex align-items-center">
                                                    <div style="width: 40px; height: 40px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" id="timerOvertimeBgPreview"></div>
                                                    <input type="hidden" id="timerOvertimeBg" value="#ff0000">
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label small">Text</label>
                                                <div class="d-flex align-items-center">
                                                    <div style="width: 40px; height: 40px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" id="timerOvertimeFgPreview"></div>
                                                    <input type="hidden" id="timerOvertimeFg" value="#ffffff">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="timerSound" class="form-label">Sound when timer reaches 0</label>
                                    <div class="d-flex gap-2">
                                        <select class="form-select" id="timerSound">
                                            <option value="">No Sound</option>
                                            <option value="beep">Beep</option>
                                            <option value="bell">Bell</option>
                                            <option value="chime">Chime</option>
                                            <option value="custom">Custom (audio/sound2-1.wav)</option>
                                        </select>
                                        <button type="button" class="btn btn-outline-secondary" id="testSoundBtn">Test</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveTopicBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
        // Global variables
        let mqttClient = null;
        let topics = [];
        let currentTopicIndex = -1;
        let selectedRow = null;
        let timerIntervals = {}; // Store timer interval IDs by topic name

        // Color palette definition
        const colorPalette = [
            '#ffffff', '#f8f9fa', '#e9ecef', '#dee2e6',
            '#adb5bd', '#6c757d', '#495057', '#343a40',
            '#212529', '#000000', '#ff0000', '#dc3545',
            '#fd7e14', '#ffc107', '#28a745', '#20c997',
            '#17a2b8', '#007bff', '#6f42c1', '#e83e8c',
            '#ffebee', '#fff3e0', '#f3e5f5', '#e8f5e8',
            '#e3f2fd', '#fce4ec', '#ffcdd2', '#d7ccc8'
        ];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadTopics();
            loadTheme();

            // Tile view is always enabled now (no setting needed)
            updateViewToggleButton();

            // Load saved view mode
            currentView = localStorage.getItem('currentView') || 'list';

            renderTopics();
            updateView();
            initializeEventListeners();

            // Set initial disconnected state
            document.getElementById('tileControlBar').classList.add('disconnected');

            // Auto-connect if settings are available
            setTimeout(autoConnectMQTT, 1000); // Delay to ensure UI is ready
        });

        // Event listeners
        function initializeEventListeners() {
            // Settings button
            document.getElementById('settingsBtn').addEventListener('click', function() {
                new bootstrap.Modal(document.getElementById('settingsModal')).show();
            });

            // Add topic button
            document.getElementById('addTopicBtn').addEventListener('click', function() {
                currentTopicIndex = -1;
                showTopicModal();
            });

            // MQTT connection buttons
            document.getElementById('connectBtn').addEventListener('click', connectMQTT);
            document.getElementById('disconnectBtn').addEventListener('click', disconnectMQTT);

            // Settings save
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);

            // Topic modal
            document.getElementById('saveTopicBtn').addEventListener('click', saveTopic);
            document.getElementById('addPayloadBtn').addEventListener('click', function() {
                addPayloadEntry();
            });
            document.getElementById('functionType').addEventListener('change', toggleFunctionSettings);

            // Export/Import
            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('importBtn').addEventListener('click', importData);

            // Context menu
            document.addEventListener('click', hideContextMenu);
            document.getElementById('editTopic').addEventListener('click', editSelectedTopic);
            document.getElementById('duplicateTopic').addEventListener('click', duplicateSelectedTopic);
            document.getElementById('deleteTopic').addEventListener('click', deleteSelectedTopic);

            // Theme toggle
            document.getElementById('themeBtn').addEventListener('click', toggleTheme);

            // View toggle
            document.getElementById('viewToggle').addEventListener('click', toggleView);

            // Tile control bar buttons
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
            document.getElementById('tileThemeBtn').addEventListener('click', toggleTheme);
            document.getElementById('tileViewBtn').addEventListener('click', toggleView);
            document.getElementById('tileSettingsBtn').addEventListener('click', function() {
                new bootstrap.Modal(document.getElementById('settingsModal')).show();
            });
            document.getElementById('tileAddBtn').addEventListener('click', function() {
                currentTopicIndex = -1;
                showTopicModal();
            });

            // Timer color pickers
            document.getElementById('timerCountdownBgPreview').addEventListener('click', function() {
                showTimerColorPalette(this, 'timerCountdownBg');
            });
            document.getElementById('timerCountdownFgPreview').addEventListener('click', function() {
                showTimerColorPalette(this, 'timerCountdownFg');
            });
            document.getElementById('timerOvertimeBgPreview').addEventListener('click', function() {
                showTimerColorPalette(this, 'timerOvertimeBg');
            });
            document.getElementById('timerOvertimeFgPreview').addEventListener('click', function() {
                showTimerColorPalette(this, 'timerOvertimeFg');
            });

            // Test sound button
            document.getElementById('testSoundBtn').addEventListener('click', testTimerSound);
        }

        // Auto-connect MQTT if settings are available
        function autoConnectMQTT() {
            const host = document.getElementById('mqttHost').value;
            if (host && host.trim() !== '' && !mqttClient) {
                console.log('Auto-connecting to MQTT...');
                connectMQTT();
            }
        }

        // MQTT connection management
        function connectMQTT() {
            const host = document.getElementById('mqttHost').value;
            const port = document.getElementById('mqttPort').value;
            const username = document.getElementById('mqttUsername').value;
            const password = document.getElementById('mqttPassword').value;
            const statusTopic = document.getElementById('statusTopic').value;
            const onlinePayload = document.getElementById('onlinePayload').value;
            const awayPayload = document.getElementById('awayPayload').value;

            if (!host) {
                alert('Please enter a host');
                return;
            }

            // Determine protocol based on page protocol
            // If page is HTTPS, use wss://, otherwise use ws://
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';

            const options = {
                username: username || undefined,
                password: password || undefined
            };

            // Add will message if status topic is configured
            if (statusTopic && awayPayload) {
                options.will = {
                    topic: statusTopic,
                    payload: awayPayload,
                    qos: 0,
                    retain: true
                };
            }

            // Build connection URL with appropriate protocol
            const url = `${protocol}${host}:${port}/mqtt`;

            mqttClient = mqtt.connect(url, options);

            mqttClient.on('connect', function() {
                console.log('MQTT connected successfully');
                document.getElementById('connectionStatus').className = 'status-indicator status-connected';
                document.getElementById('tileControlBar').classList.remove('disconnected');

                // Publish online status if configured
                if (statusTopic && onlinePayload) {
                    mqttClient.publish(statusTopic, onlinePayload, { retain: true });
                    console.log(`Published online status: ${statusTopic} = ${onlinePayload}`);
                }

                subscribeToTopics();
                startScheduleChecker();
            });

            mqttClient.on('message', function(topic, message, packet) {
                handleMessage(topic, message.toString(), packet.retain);
            });

            mqttClient.on('error', function(error) {
                console.error('MQTT Error:', error);
                document.getElementById('connectionStatus').className = 'status-indicator status-disconnected';
                document.getElementById('tileControlBar').classList.add('disconnected');
                // Reset client reference on error
                mqttClient = null;
            });

            mqttClient.on('close', function() {
                console.log('MQTT connection closed');
                document.getElementById('connectionStatus').className = 'status-indicator status-disconnected';
                document.getElementById('tileControlBar').classList.add('disconnected');
                // Reset client reference on close
                mqttClient = null;
            });
        }

        function disconnectMQTT() {
            if (mqttClient) {
                mqttClient.end();
                mqttClient = null;
            }
            document.getElementById('connectionStatus').className = 'status-indicator status-disconnected';
            document.getElementById('tileControlBar').classList.add('disconnected');
        }

        function subscribeToTopics() {
            if (!mqttClient) return;

            topics.forEach(topic => {
                if (topic.name) {
                    mqttClient.subscribe(topic.name);
                }
            });
        }

        // Message handling
        function handleMessage(topic, payload, retain) {
            const topicConfig = topics.find(t => t.name === topic);
            if (!topicConfig) return;

            // Store retain flag for later use
            topicConfig.lastRetain = retain;

            // Always update display regardless of function enabled status
            updateTopicDisplay(topic, payload);

            // Execute function only if enabled
            if (topicConfig.functionEnabled && topicConfig.functionType) {
                switch (topicConfig.functionType) {
                    case 'transfer':
                        handleTransfer(topicConfig, payload);
                        break;
                    case 'convert':
                        handleConvert(topicConfig, payload);
                        break;
                    case 'cycle':
                        handleCycle(topicConfig, payload);
                        break;
                    case 'timer':
                        handleTimer(topicConfig, payload);
                        break;
                }
            }
        }

        function handleTransfer(topicConfig, payload) {
            if (topicConfig.transferTopic && mqttClient) {
                const options = { retain: topicConfig.lastRetain || false };
                mqttClient.publish(topicConfig.transferTopic, payload, options);
            }
        }

        function handleConvert(topicConfig, payload) {
            if (!topicConfig.convertTopic || !mqttClient) return;

            const payloadValue = topicConfig.payloadValues.find(pv => pv.value === payload);
            const convertValue = payloadValue ? payloadValue.convertValue : topicConfig.convertDefault;

            if (convertValue !== undefined && convertValue !== null) {
                const options = { retain: topicConfig.lastRetain || false };
                mqttClient.publish(topicConfig.convertTopic, convertValue, options);
            }
        }

        function handleCycle(topicConfig, payload) {
            if (!mqttClient) return;

            const isNext = payload === topicConfig.cycleNextPayload;
            const isPrev = payload === topicConfig.cyclePrevPayload;

            if (!isNext && !isPrev) return;

            const values = topicConfig.payloadValues.map(pv => pv.value);
            if (values.length === 0) return;

            let currentIndex = values.indexOf(topicConfig.currentValue);
            if (currentIndex === -1) currentIndex = -1;

            let nextIndex;
            if (isNext) {
                nextIndex = (currentIndex + 1) % values.length;
            } else {
                nextIndex = currentIndex <= 0 ? values.length - 1 : currentIndex - 1;
            }

            const nextValue = values[nextIndex];
            topicConfig.currentValue = nextValue;

            mqttClient.publish(topicConfig.name, nextValue, { retain: true });
            saveTopics();
        }

        function handleTimer(topicConfig, payload) {
            if (!mqttClient) return;

            // Check if payload is a number (start countdown)
            const seconds = parseInt(payload);
            if (!isNaN(seconds)) {
                // Check if timer is already running with this value
                if (timerIntervals[topicConfig.name] && topicConfig.timerRemaining === seconds) {
                    // Timer already running, don't restart
                    return;
                }

                // Clear existing timer for this topic
                if (timerIntervals[topicConfig.name]) {
                    clearInterval(timerIntervals[topicConfig.name]);
                    delete timerIntervals[topicConfig.name];
                }

                // Store initial timer value
                topicConfig.timerRemaining = seconds;

                // Start countdown if seconds > 0
                if (seconds > 0) {
                    const interval = setInterval(() => {
                        topicConfig.timerRemaining--;

                        // Publish new value
                        mqttClient.publish(topicConfig.name, String(topicConfig.timerRemaining));

                        // Play sound when reaching 0
                        if (topicConfig.timerRemaining === 0 && topicConfig.timerSound) {
                            playTimerSound(topicConfig.timerSound);
                        }

                        // Continue into negative (overtime) until stopped
                        if (topicConfig.timerRemaining < -999) {
                            // Safety limit: stop at -999 seconds
                            clearInterval(timerIntervals[topicConfig.name]);
                            delete timerIntervals[topicConfig.name];
                        }
                    }, (topicConfig.timerInterval || 1) * 1000);

                    timerIntervals[topicConfig.name] = interval;
                }
            } else {
                // Non-numeric payload: stop timer
                if (timerIntervals[topicConfig.name]) {
                    clearInterval(timerIntervals[topicConfig.name]);
                    delete timerIntervals[topicConfig.name];
                }
                topicConfig.timerRemaining = null;
            }
        }

        function playTimerSound(sound) {
            if (sound === 'custom') {
                // Play custom audio file
                const audio = new Audio('audio/sound2-1.wav');
                audio.play().catch(err => console.error('Error playing audio:', err));
            } else {
                // Play synthesized sound
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                switch (sound) {
                    case 'beep':
                        oscillator.frequency.value = 800;
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.2);
                        break;
                    case 'bell':
                        oscillator.frequency.value = 1000;
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.5);
                        break;
                    case 'chime':
                        oscillator.frequency.value = 1200;
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.15);
                        setTimeout(() => {
                            const osc2 = audioContext.createOscillator();
                            const gain2 = audioContext.createGain();
                            osc2.connect(gain2);
                            gain2.connect(audioContext.destination);
                            osc2.frequency.value = 900;
                            gain2.gain.setValueAtTime(0.3, audioContext.currentTime);
                            osc2.start();
                            osc2.stop(audioContext.currentTime + 0.15);
                        }, 150);
                        break;
                }
            }
        }

        function formatTimerDisplay(seconds) {
            const absSeconds = Math.abs(seconds);
            const hours = Math.floor(absSeconds / 3600);
            const minutes = Math.floor((absSeconds % 3600) / 60);
            const secs = absSeconds % 60;

            const sign = seconds < 0 ? '-' : '';

            if (hours > 0) {
                return `${sign}${hours}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            } else {
                return `${sign}${minutes}:${String(secs).padStart(2, '0')}`;
            }
        }

        // Topic management
        function showTopicModal(topicData = null) {
            const modal = new bootstrap.Modal(document.getElementById('topicModal'));

            // Reset form
            document.getElementById('topicForm').reset();
            document.getElementById('payloadValues').innerHTML = '';
            document.getElementById('functionType').value = '';
            toggleFunctionSettings();

            if (topicData) {
                // Edit mode
                document.getElementById('topicModalTitle').textContent = 'Edit Topic';
                document.getElementById('topicLabel').value = topicData.label || '';
                document.getElementById('topicName').value = topicData.name || '';
                document.getElementById('functionType').value = topicData.functionType || '';
                document.getElementById('showInTileView').checked = topicData.showInTileView !== false;

                // Load payload values
                if (topicData.payloadValues) {
                    topicData.payloadValues.forEach(pv => {
                        addPayloadEntry(pv);
                    });
                }

                // Load function settings
                if (topicData.functionType) {
                    toggleFunctionSettings();
                    switch (topicData.functionType) {
                        case 'transfer':
                            document.getElementById('transferTopic').value = topicData.transferTopic || '';
                            break;
                        case 'convert':
                            document.getElementById('convertTopic').value = topicData.convertTopic || '';
                            document.getElementById('convertDefault').value = topicData.convertDefault || '';
                            break;
                        case 'cycle':
                            document.getElementById('cycleNextPayload').value = topicData.cycleNextPayload || '';
                            document.getElementById('cyclePrevPayload').value = topicData.cyclePrevPayload || '';
                            break;
                        case 'schedule':
                            if (topicData.schedules && topicData.schedules.length > 0) {
                                // Load Schedule 1
                                const schedule1 = topicData.schedules[0];
                                schedule1.days.forEach(day => {
                                    const checkbox = document.querySelector(`.schedule1-day[value="${day}"]`);
                                    if (checkbox) checkbox.checked = true;
                                });
                                document.getElementById('schedule1Time').value = schedule1.time || '';
                                document.getElementById('schedule1Payload').value = schedule1.payload || '';
                                document.getElementById('schedule1Enabled').checked = schedule1.enabled !== false;

                                // Load Schedule 2 if exists
                                if (topicData.schedules.length > 1) {
                                    const schedule2 = topicData.schedules[1];
                                    schedule2.days.forEach(day => {
                                        const checkbox = document.querySelector(`.schedule2-day[value="${day}"]`);
                                        if (checkbox) checkbox.checked = true;
                                    });
                                    document.getElementById('schedule2Time').value = schedule2.time || '';
                                    document.getElementById('schedule2Payload').value = schedule2.payload || '';
                                    document.getElementById('schedule2Enabled').checked = schedule2.enabled !== false;
                                }
                            }
                            break;
                        case 'timer':
                            document.getElementById('timerInterval').value = topicData.timerInterval || 1;
                            document.getElementById('timerCountdownBg').value = topicData.timerCountdownBg || '#007bff';
                            document.getElementById('timerCountdownFg').value = topicData.timerCountdownFg || '#ffffff';
                            document.getElementById('timerOvertimeBg').value = topicData.timerOvertimeBg || '#ff0000';
                            document.getElementById('timerOvertimeFg').value = topicData.timerOvertimeFg || '#ffffff';
                            document.getElementById('timerSound').value = topicData.timerSound || '';
                            // Update color previews
                            document.getElementById('timerCountdownBgPreview').style.backgroundColor = topicData.timerCountdownBg || '#007bff';
                            document.getElementById('timerCountdownFgPreview').style.backgroundColor = topicData.timerCountdownFg || '#ffffff';
                            document.getElementById('timerOvertimeBgPreview').style.backgroundColor = topicData.timerOvertimeBg || '#ff0000';
                            document.getElementById('timerOvertimeFgPreview').style.backgroundColor = topicData.timerOvertimeFg || '#ffffff';
                            break;
                    }
                }
            } else {
                // Add mode
                document.getElementById('topicModalTitle').textContent = 'New Topic';
                addPayloadEntry(); // Add one empty entry
            }

            modal.show();
        }

        function addPayloadEntry(data = null) {
            const container = document.getElementById('payloadValues');

            // Determine default colors based on payload count (before adding new entry)
            const existingPayloads = container.querySelectorAll('.payload-entry').length;
            let defaultBgColor = '#ffffff';
            let defaultTextColor = '#000000';

            if (!data) {
                if (existingPayloads === 0) {
                    // First payload
                    defaultBgColor = '#20c997';
                    defaultTextColor = '#ffffff';
                } else {
                    // Second and subsequent payloads
                    defaultBgColor = '#ff0000';
                    defaultTextColor = '#ffffff';
                }
            }

            const entry = document.createElement('div');
            entry.className = 'row mb-2 payload-entry';

            const bgColor = (data && data.backgroundColor) ? data.backgroundColor : defaultBgColor;
            const txtColor = (data && data.textColor) ? data.textColor : defaultTextColor;

            entry.innerHTML = `
                <div class="col-md-3">
                    <input type="text" class="form-control payload-value" placeholder="Payload Value" value="${data?.value || ''}">
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control payload-display" placeholder="Display Text" value="${data?.display || ''}">
                </div>
                <div class="col-md-2">
                    <div class="mb-2">
                        <label class="form-label small">Background</label>
                        <div class="d-flex align-items-center">
                            <div class="color-preview" style="width: 25px; height: 25px; border: 1px solid #ddd; border-radius: 4px; background-color: ${bgColor}; margin-right: 8px; cursor: pointer;" data-target="backgroundColor"></div>
                            <button type="button" class="btn btn-sm btn-outline-secondary color-palette-btn" data-target="backgroundColor" style="font-size: 0.75rem; padding: 2px 8px;">Select</button>
                        </div>
                    </div>
                    <div>
                        <label class="form-label small">Text Color</label>
                        <div class="d-flex align-items-center">
                            <div class="color-preview" style="width: 25px; height: 25px; border: 1px solid #ddd; border-radius: 4px; background-color: ${txtColor}; margin-right: 8px; cursor: pointer;" data-target="textColor"></div>
                            <button type="button" class="btn btn-sm btn-outline-secondary color-palette-btn" data-target="textColor" style="font-size: 0.75rem; padding: 2px 8px;">Select</button>
                        </div>
                    </div>
                    <input type="hidden" class="payload-background-color" value="${bgColor}">
                    <input type="hidden" class="payload-text-color" value="${txtColor}">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control convert-value" placeholder="Convert Value" value="${data?.convertValue || ''}">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-payload">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;

            entry.querySelector('.remove-payload').addEventListener('click', function() {
                entry.remove();
            });

            // Add color palette event listeners
            const colorPaletteBtns = entry.querySelectorAll('.color-palette-btn');
            colorPaletteBtns.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showColorPalette(this, entry);
                });
            });

            const colorPreviews = entry.querySelectorAll('.color-preview');
            colorPreviews.forEach(preview => {
                preview.addEventListener('click', function() {
                    const btn = this.parentElement.querySelector('.color-palette-btn');
                    showColorPalette(btn, entry);
                });
            });

            container.appendChild(entry);
        }

        function toggleFunctionSettings() {
            const functionType = document.getElementById('functionType').value;

            document.getElementById('transferSettings').classList.add('d-none');
            document.getElementById('convertSettings').classList.add('d-none');
            document.getElementById('cycleSettings').classList.add('d-none');
            document.getElementById('scheduleSettings').classList.add('d-none');
            document.getElementById('timerSettings').classList.add('d-none');

            if (functionType) {
                document.getElementById(`${functionType}Settings`).classList.remove('d-none');

                // Update timer color previews when switching to timer mode
                if (functionType === 'timer') {
                    const countdownBg = document.getElementById('timerCountdownBg').value;
                    const countdownFg = document.getElementById('timerCountdownFg').value;
                    const overtimeBg = document.getElementById('timerOvertimeBg').value;
                    const overtimeFg = document.getElementById('timerOvertimeFg').value;

                    document.getElementById('timerCountdownBgPreview').style.backgroundColor = countdownBg;
                    document.getElementById('timerCountdownFgPreview').style.backgroundColor = countdownFg;
                    document.getElementById('timerOvertimeBgPreview').style.backgroundColor = overtimeBg;
                    document.getElementById('timerOvertimeFgPreview').style.backgroundColor = overtimeFg;
                }
            }
        }

        function saveTopic() {
            const form = document.getElementById('topicForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const topicData = {
                label: document.getElementById('topicLabel').value,
                name: document.getElementById('topicName').value,
                functionType: document.getElementById('functionType').value,
                functionEnabled: true,
                showInTileView: document.getElementById('showInTileView').checked,
                payloadValues: [],
                currentValue: null,
                currentPayload: null
            };

            // Collect payload values
            const payloadEntries = document.querySelectorAll('.payload-entry');
            payloadEntries.forEach(entry => {
                const value = entry.querySelector('.payload-value').value;
                const display = entry.querySelector('.payload-display').value;
                const backgroundColor = entry.querySelector('.payload-background-color').value;
                const textColor = entry.querySelector('.payload-text-color').value;
                const convertValue = entry.querySelector('.convert-value').value;

                if (value) {
                    topicData.payloadValues.push({
                        value,
                        display: display || value,
                        backgroundColor,
                        textColor,
                        convertValue
                    });
                }
            });

            // Function-specific settings
            switch (topicData.functionType) {
                case 'transfer':
                    topicData.transferTopic = document.getElementById('transferTopic').value;
                    break;
                case 'convert':
                    topicData.convertTopic = document.getElementById('convertTopic').value;
                    topicData.convertDefault = document.getElementById('convertDefault').value;
                    break;
                case 'cycle':
                    topicData.cycleNextPayload = document.getElementById('cycleNextPayload').value;
                    topicData.cyclePrevPayload = document.getElementById('cyclePrevPayload').value;
                    break;
                case 'schedule':
                    topicData.schedules = [];
                    // Collect Schedule 1
                    const schedule1Days = Array.from(document.querySelectorAll('.schedule1-day:checked')).map(cb => parseInt(cb.value));
                    const schedule1Time = document.getElementById('schedule1Time').value;
                    const schedule1Payload = document.getElementById('schedule1Payload').value;
                    const schedule1Enabled = document.getElementById('schedule1Enabled').checked;
                    if (schedule1Days.length > 0 && schedule1Time && schedule1Payload) {
                        topicData.schedules.push({
                            days: schedule1Days,
                            time: schedule1Time,
                            payload: schedule1Payload,
                            enabled: schedule1Enabled
                        });
                    }
                    // Collect Schedule 2
                    const schedule2Days = Array.from(document.querySelectorAll('.schedule2-day:checked')).map(cb => parseInt(cb.value));
                    const schedule2Time = document.getElementById('schedule2Time').value;
                    const schedule2Payload = document.getElementById('schedule2Payload').value;
                    const schedule2Enabled = document.getElementById('schedule2Enabled').checked;
                    if (schedule2Days.length > 0 && schedule2Time && schedule2Payload) {
                        topicData.schedules.push({
                            days: schedule2Days,
                            time: schedule2Time,
                            payload: schedule2Payload,
                            enabled: schedule2Enabled
                        });
                    }
                    break;
                case 'timer':
                    topicData.timerInterval = parseInt(document.getElementById('timerInterval').value) || 1;
                    topicData.timerCountdownBg = document.getElementById('timerCountdownBg').value;
                    topicData.timerCountdownFg = document.getElementById('timerCountdownFg').value;
                    topicData.timerOvertimeBg = document.getElementById('timerOvertimeBg').value;
                    topicData.timerOvertimeFg = document.getElementById('timerOvertimeFg').value;
                    topicData.timerSound = document.getElementById('timerSound').value;
                    break;
            }

            if (currentTopicIndex >= 0) {
                topics[currentTopicIndex] = topicData;
            } else {
                topics.push(topicData);
            }

            saveTopics();
            renderTopics();

            if (mqttClient && mqttClient.connected) {
                mqttClient.subscribe(topicData.name);
            }

            bootstrap.Modal.getInstance(document.getElementById('topicModal')).hide();
        }

        // UI rendering
        function renderTopics() {
            const tbody = document.getElementById('topicTableBody');
            tbody.innerHTML = '';

            topics.forEach((topic, index) => {
                const row = document.createElement('tr');
                row.className = 'topic-row';
                row.dataset.index = index;

                let displayText, backgroundColor, textColor;

                // Special handling for timer function
                if (topic.functionType === 'timer') {
                    // Check if there's a matching payload value first (for both numeric and non-numeric)
                    const currentPayloadValue = topic.payloadValues && topic.payloadValues.find(pv => pv.value === topic.currentPayload);

                    if (currentPayloadValue) {
                        // Use payload value settings if available
                        displayText = currentPayloadValue.display;
                        backgroundColor = currentPayloadValue.backgroundColor;
                        textColor = currentPayloadValue.textColor;
                    } else {
                        const seconds = parseInt(topic.currentPayload);
                        if (!isNaN(seconds)) {
                            // Format time display
                            displayText = formatTimerDisplay(seconds);

                            // Use timer colors
                            if (seconds >= 0) {
                                backgroundColor = topic.timerCountdownBg || '#007bff';
                                textColor = topic.timerCountdownFg || '#ffffff';
                            } else {
                                backgroundColor = topic.timerOvertimeBg || '#ff0000';
                                textColor = topic.timerOvertimeFg || '#ffffff';
                            }
                        } else {
                            displayText = topic.currentPayload || '';
                            backgroundColor = '#ffffff';
                            textColor = '#000000';
                        }
                    }
                } else {
                    const currentPayloadValue = topic.payloadValues.find(pv => pv.value === topic.currentPayload);
                    displayText = currentPayloadValue ? currentPayloadValue.display : (topic.currentPayload || '');
                    backgroundColor = currentPayloadValue ? currentPayloadValue.backgroundColor : '#ffffff';
                    textColor = currentPayloadValue ? currentPayloadValue.textColor : '#000000';
                }

                const functionText = topic.functionType ?
                    `${getFunctionDisplayName(topic.functionType)} (${topic.functionEnabled ? 'ON' : 'OFF'})` : '';

                row.innerHTML = `
                    <td class="drag-handle" title="Drag to reorder">
                        <i class="bi bi-grip-vertical"></i>
                    </td>
                    <td>${topic.label}</td>
                    <td>${displayText}</td>
                    <td>${topic.name}</td>
                    <td class="payload-cell" data-index="${index}">
                        <span class="payload-value">${topic.currentPayload || ''}</span>
                    </td>
                    <td>
                        ${topic.functionType ? `<span class="function-toggle ${topic.functionEnabled ? 'function-active' : 'function-inactive'}" data-index="${index}">
                            ${getFunctionDisplayName(topic.functionType)}
                        </span>` : ''}
                    </td>
                `;

                // Make row draggable
                row.draggable = true;
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragend', handleDragEnd);
                row.addEventListener('dragenter', handleDragEnter);
                row.addEventListener('dragleave', handleDragLeave);

                // Apply colors after innerHTML is set
                if (backgroundColor && backgroundColor !== '#ffffff') {
                    row.classList.add('topic-row-colored');
                    row.style.setProperty('--row-bg-color', backgroundColor);
                    row.style.setProperty('--row-text-color', textColor);

                    // Override Bootstrap CSS variables and apply directly
                    row.style.setProperty('--bs-table-bg', backgroundColor, 'important');
                    row.style.setProperty('--bs-table-color', textColor, 'important');
                    row.style.setProperty('background-color', backgroundColor, 'important');
                    row.style.setProperty('color', textColor, 'important');

                    // Force apply colors to all cells
                    const cells = row.querySelectorAll('td');
                    cells.forEach(cell => {
                        cell.style.setProperty('--bs-table-bg', backgroundColor, 'important');
                        cell.style.setProperty('--bs-table-color', textColor, 'important');
                        cell.style.setProperty('background-color', backgroundColor, 'important');
                        cell.style.setProperty('color', textColor, 'important');
                        cell.style.setProperty('background', backgroundColor, 'important');
                    });
                } else {
                    row.classList.remove('topic-row-colored');
                    row.style.removeProperty('--row-bg-color');
                    row.style.removeProperty('--row-text-color');
                    row.style.removeProperty('--bs-table-bg');
                    row.style.removeProperty('--bs-table-color');
                    row.style.removeProperty('background-color');
                    row.style.removeProperty('color');

                    // Remove forced colors from cells
                    const cells = row.querySelectorAll('td');
                    cells.forEach(cell => {
                        cell.style.removeProperty('--bs-table-bg');
                        cell.style.removeProperty('--bs-table-color');
                        cell.style.removeProperty('background-color');
                        cell.style.removeProperty('color');
                        cell.style.removeProperty('background');
                    });
                }

                // Add event listeners
                row.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    showContextMenu(e, index);
                });

                // Add payload edit listener
                const payloadCell = row.querySelector('.payload-cell');
                if (payloadCell) {
                    payloadCell.addEventListener('click', function(e) {
                        e.stopPropagation();
                        showPayloadEditor(this, index);
                    });
                }

                const functionToggle = row.querySelector('.function-toggle');
                if (functionToggle) {
                    functionToggle.addEventListener('click', function(e) {
                        e.stopPropagation();
                        toggleFunction(index);
                    });
                }

                tbody.appendChild(row);
            });
        }

        function getFunctionDisplayName(functionType) {
            switch (functionType) {
                case 'transfer': return 'Transfer';
                case 'convert': return 'Convert';
                case 'cycle': return 'Cycle';
                case 'schedule': return 'Schedule';
                case 'timer': return 'Timer';
                default: return '';
            }
        }

        function updateTopicDisplay(topicName, payload) {
            const topic = topics.find(t => t.name === topicName);
            if (topic) {
                topic.currentPayload = payload;
                saveTopics();

                if (currentView === 'tile') {
                    renderTileView();
                } else {
                    renderTopics();
                }
            }
        }

        function toggleFunction(index) {
            topics[index].functionEnabled = !topics[index].functionEnabled;
            saveTopics();

            if (currentView === 'tile') {
                renderTileView();
            } else {
                renderTopics();
            }
        }

        // Context menu
        function showContextMenu(e, index) {
            selectedRow = index;
            const topic = topics[index];
            const contextMenu = document.getElementById('contextMenu');
            const payloadMenuItems = document.getElementById('payloadMenuItems');

            // Clear previous payload items
            payloadMenuItems.innerHTML = '';

            // Add payload value options if available
            if (topic.payloadValues && topic.payloadValues.length > 0) {
                topic.payloadValues.forEach(pv => {
                    const item = document.createElement('div');
                    item.className = 'context-menu-item';
                    item.textContent = `Publish: ${pv.display || pv.value}`;
                    item.addEventListener('click', function() {
                        publishPayloadValue(index, pv.value);
                        hideContextMenu();
                    });
                    payloadMenuItems.appendChild(item);
                });

                // Add separator
                const separator = document.createElement('div');
                separator.style.borderBottom = '1px solid #eee';
                separator.style.margin = '5px 0';
                payloadMenuItems.appendChild(separator);
            }

            contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.top = e.pageY + 'px';
            contextMenu.classList.remove('d-none');
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.add('d-none');
            selectedRow = null;
        }

        function editSelectedTopic() {
            if (selectedRow !== null) {
                currentTopicIndex = selectedRow;
                showTopicModal(topics[selectedRow]);
            }
            hideContextMenu();
        }

        function deleteSelectedTopic() {
            if (selectedRow !== null) {
                if (confirm('Delete this topic?')) {
                    topics.splice(selectedRow, 1);
                    saveTopics();
                    renderTopics();
                }
            }
            hideContextMenu();
        }

        function duplicateSelectedTopic() {
            if (selectedRow !== null) {
                const originalTopic = topics[selectedRow];
                // Create a deep copy of the topic
                const duplicatedTopic = JSON.parse(JSON.stringify(originalTopic));

                // Modify the label to indicate it's a copy
                duplicatedTopic.label = originalTopic.label + ' (Copy)';

                // Reset current values
                duplicatedTopic.currentPayload = null;
                duplicatedTopic.currentValue = null;

                // Insert the duplicated topic right after the original
                const newIndex = selectedRow + 1;
                topics.splice(newIndex, 0, duplicatedTopic);

                saveTopics();
                renderTopics();

                // Auto-subscribe if connected
                if (mqttClient && mqttClient.connected && duplicatedTopic.name) {
                    mqttClient.subscribe(duplicatedTopic.name);
                }

                // Open the edit modal for the duplicated topic
                hideContextMenu();
                currentTopicIndex = newIndex;
                showTopicModal();
            } else {
                hideContextMenu();
            }
        }

        function publishPayloadValue(topicIndex, value) {
            const topic = topics[topicIndex];
            if (!topic || !mqttClient || !mqttClient.connected) return;

            // Update current payload and publish with retain
            topic.currentPayload = value;
            saveTopics();
            mqttClient.publish(topic.name, value, { retain: true });
            console.log(`Published: ${topic.name} = ${value}`);

            // Update display
            renderTopics();
        }

        // Data persistence
        function saveSettings() {
            const settings = {
                mqttHost: document.getElementById('mqttHost').value,
                mqttPort: document.getElementById('mqttPort').value,
                mqttUsername: document.getElementById('mqttUsername').value,
                mqttPassword: document.getElementById('mqttPassword').value,
                statusTopic: document.getElementById('statusTopic').value,
                onlinePayload: document.getElementById('onlinePayload').value,
                awayPayload: document.getElementById('awayPayload').value
            };

            localStorage.setItem('mqttPanelSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const settings = localStorage.getItem('mqttPanelSettings');
            if (settings) {
                const parsed = JSON.parse(settings);
                document.getElementById('mqttHost').value = parsed.mqttHost || '';
                document.getElementById('mqttPort').value = parsed.mqttPort || '8083';
                document.getElementById('mqttUsername').value = parsed.mqttUsername || '';
                document.getElementById('mqttPassword').value = parsed.mqttPassword || '';
                document.getElementById('statusTopic').value = parsed.statusTopic || '';
                document.getElementById('onlinePayload').value = parsed.onlinePayload || '';
                document.getElementById('awayPayload').value = parsed.awayPayload || '';
            }
        }

        function saveTopics() {
            localStorage.setItem('mqttPanelTopics', JSON.stringify(topics));
        }

        function loadTopics() {
            const saved = localStorage.getItem('mqttPanelTopics');
            if (saved) {
                topics = JSON.parse(saved);
            }
        }

        function exportData() {
            const data = {
                topics: topics,
                settings: JSON.parse(localStorage.getItem('mqttPanelSettings') || '{}')
            };
            document.getElementById('dataTextArea').value = JSON.stringify(data, null, 2);
        }

        function importData() {
            try {
                const data = JSON.parse(document.getElementById('dataTextArea').value);
                if (data.topics) {
                    // Convert old color format to new format
                    data.topics.forEach(topic => {
                        if (topic.payloadValues) {
                            topic.payloadValues.forEach(pv => {
                                if (pv.color && !pv.backgroundColor) {
                                    pv.backgroundColor = pv.color;
                                    pv.textColor = '#000000';
                                }
                            });
                        }
                    });
                    topics = data.topics;
                    saveTopics();
                    renderTopics();
                }
                if (data.settings) {
                    localStorage.setItem('mqttPanelSettings', JSON.stringify(data.settings));
                    loadSettings();
                }
                alert('Data imported successfully');
            } catch (error) {
                alert('Invalid data format');
            }
        }

        // Color palette functions
        function showColorPalette(button, entry) {
            const target = button.dataset.target;
            const currentColor = entry.querySelector(`.payload-${target.toLowerCase().replace('color', '')}-color`).value;

            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'color-palette-modal';
            modal.innerHTML = `
                <div class="color-palette-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">${target === 'backgroundColor' ? 'Select Background Color' : 'Select Text Color'}</h6>
                        <button type="button" class="btn-close" aria-label="Close"></button>
                    </div>
                    <div class="color-palette" id="colorPalette">
                        ${colorPalette.map(color =>
                            `<div class="color-option ${color === currentColor ? 'selected' : ''}"
                                 style="background-color: ${color}"
                                 data-color="${color}"></div>`
                        ).join('')}
                    </div>
                    <div class="mt-3 text-end">
                        <button type="button" class="btn btn-secondary me-2" id="cancelColorBtn">Cancel</button>
                        <button type="button" class="btn btn-primary" id="selectColorBtn">Select</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            let selectedColor = currentColor;

            // Color option click events
            modal.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    modal.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedColor = this.dataset.color;
                });
            });

            // Close button
            modal.querySelector('.btn-close').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            // Cancel button
            modal.querySelector('#cancelColorBtn').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            // Select button
            modal.querySelector('#selectColorBtn').addEventListener('click', () => {
                updateEntryColor(entry, target, selectedColor);
                document.body.removeChild(modal);
            });

            // Click outside to close
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        function updateEntryColor(entry, target, color) {
            const preview = entry.querySelector(`[data-target="${target}"]`);
            const hiddenInput = entry.querySelector(`.payload-${target.toLowerCase().replace('color', '')}-color`);

            preview.style.backgroundColor = color;
            hiddenInput.value = color;
        }

        // Timer color palette functions
        function showTimerColorPalette(preview, targetId) {
            const currentColor = document.getElementById(targetId).value;

            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'color-palette-modal';
            modal.innerHTML = `
                <div class="color-palette-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Select Color</h6>
                        <button type="button" class="btn-close" aria-label="Close"></button>
                    </div>
                    <div class="color-palette" id="colorPalette">
                        ${colorPalette.map(color =>
                            `<div class="color-option ${color === currentColor ? 'selected' : ''}"
                                 style="background-color: ${color}"
                                 data-color="${color}"></div>`
                        ).join('')}
                    </div>
                    <div class="mt-3 text-end">
                        <button type="button" class="btn btn-secondary me-2" id="cancelColorBtn">Cancel</button>
                        <button type="button" class="btn btn-primary" id="selectColorBtn">Select</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            let selectedColor = currentColor;

            // Color option click events
            modal.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    modal.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedColor = this.dataset.color;
                });
            });

            // Close button
            modal.querySelector('.btn-close').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            // Cancel button
            modal.querySelector('#cancelColorBtn').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            // Select button
            modal.querySelector('#selectColorBtn').addEventListener('click', () => {
                preview.style.backgroundColor = selectedColor;
                document.getElementById(targetId).value = selectedColor;
                document.body.removeChild(modal);
            });

            // Click outside to close
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        // Test timer sound
        function testTimerSound() {
            const sound = document.getElementById('timerSound').value;
            if (!sound) return;

            playTimerSound(sound);
        }

        // Payload editing functions
        function showPayloadEditor(cell, topicIndex) {
            const topic = topics[topicIndex];
            if (!topic) return;

            // Prevent multiple editors
            if (cell.querySelector('.payload-edit-container')) return;

            const currentValue = topic.currentPayload || '';

            // Create editor container
            const editorContainer = document.createElement('div');
            editorContainer.className = 'payload-edit-container';

            // Add only text input
            const editorHTML = `
                <input type="text" class="payload-edit-input" id="payloadInput_${topicIndex}"
                       value="${currentValue}" placeholder="Enter payload value">
                <div class="payload-edit-buttons">
                    <button class="payload-edit-btn save">Publish</button>
                </div>
            `;

            editorContainer.innerHTML = editorHTML;
            cell.appendChild(editorContainer);

            // Get elements
            const input = editorContainer.querySelector('.payload-edit-input');
            const saveBtn = editorContainer.querySelector('.save');

            // Focus input and select all
            setTimeout(() => {
                input.focus();
                input.select();
            }, 50);

            // Event listeners
            saveBtn.addEventListener('click', function() {
                savePayloadEdit(topicIndex);
            });

            // Handle Enter/Escape keys
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    savePayloadEdit(topicIndex);
                } else if (e.key === 'Escape') {
                    cancelPayloadEdit(topicIndex);
                }
            });

            // Handle click outside to cancel
            setTimeout(() => {
                const outsideClickHandler = function(e) {
                    if (!editorContainer.contains(e.target)) {
                        cancelPayloadEdit(topicIndex);
                        document.removeEventListener('click', outsideClickHandler);
                    }
                };
                document.addEventListener('click', outsideClickHandler);
            }, 100);
        }

        function savePayloadEdit(topicIndex) {
            const topic = topics[topicIndex];
            if (!topic) return;

            const input = document.getElementById(`payloadInput_${topicIndex}`);
            if (!input) return;

            const newValue = input.value.trim();
            const cell = input.closest('.payload-cell');

            // Update topic data
            topic.currentPayload = newValue;
            saveTopics();

            // Publish to MQTT if connected with retain
            if (mqttClient && mqttClient.connected && newValue !== '') {
                mqttClient.publish(topic.name, newValue, { retain: true });
                console.log(`Published: ${topic.name} = ${newValue}`);
            }

            // Remove editor and update display
            cancelPayloadEdit(topicIndex);
            renderTopics();
        }

        function cancelPayloadEdit(topicIndex) {
            const editorContainer = document.getElementById(`payloadInput_${topicIndex}`)?.closest('.payload-edit-container');
            if (editorContainer) {
                editorContainer.remove();
            }
        }

        // Drag and Drop functionality
        let draggedElement = null;
        let draggedIndex = null;

        function handleDragStart(e) {
            draggedElement = this;
            draggedIndex = parseInt(this.dataset.index);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (this !== draggedElement) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (this !== draggedElement) {
                const dropIndex = parseInt(this.dataset.index);
                reorderTopics(draggedIndex, dropIndex);
            }
            return false;
        }

        function handleDragEnd(e) {
            // Clean up
            const rows = document.querySelectorAll('.topic-row');
            rows.forEach(row => {
                row.classList.remove('dragging', 'drag-over');
            });
            draggedElement = null;
            draggedIndex = null;
        }

        function reorderTopics(fromIndex, toIndex) {
            if (fromIndex === toIndex) return;

            // Remove the item from the array
            const movedTopic = topics.splice(fromIndex, 1)[0];

            // Insert it at the new position
            topics.splice(toIndex, 0, movedTopic);

            // Save and re-render
            saveTopics();
            renderTopics();

            console.log(`Moved topic from position ${fromIndex} to ${toIndex}`);
        }

        // Theme management
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            updateThemeIcon(newTheme);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function updateThemeIcon(theme) {
            const themeIcon = document.getElementById('themeIcon');
            const tileThemeIcon = document.getElementById('tileThemeIcon');

            if (theme === 'dark') {
                themeIcon.className = 'bi bi-moon';
                tileThemeIcon.className = 'bi bi-moon';
            } else {
                themeIcon.className = 'bi bi-sun';
                tileThemeIcon.className = 'bi bi-sun';
            }
        }

        // Fullscreen management
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                // Enter fullscreen
                document.documentElement.requestFullscreen().then(() => {
                    updateFullscreenIcon(true);
                }).catch(err => {
                    console.error('Error attempting to enable fullscreen:', err);
                });
            } else {
                // Exit fullscreen
                document.exitFullscreen().then(() => {
                    updateFullscreenIcon(false);
                }).catch(err => {
                    console.error('Error attempting to exit fullscreen:', err);
                });
            }
        }

        function updateFullscreenIcon(isFullscreen) {
            const fullscreenIcon = document.getElementById('fullscreenIcon');
            if (isFullscreen) {
                fullscreenIcon.className = 'bi bi-fullscreen-exit';
            } else {
                fullscreenIcon.className = 'bi bi-fullscreen';
            }
        }

        // Listen for fullscreen changes (e.g., ESC key)
        document.addEventListener('fullscreenchange', function() {
            updateFullscreenIcon(!!document.fullscreenElement);
        });

        // Day selection helper functions
        function selectAllDays(scheduleId) {
            const checkboxes = document.querySelectorAll(`.${scheduleId}-day`);
            checkboxes.forEach(cb => cb.checked = true);
        }

        function deselectAllDays(scheduleId) {
            const checkboxes = document.querySelectorAll(`.${scheduleId}-day`);
            checkboxes.forEach(cb => cb.checked = false);
        }

        // View toggle functions
        let currentView = 'list'; // 'list' or 'tile'

        function toggleView() {
            currentView = currentView === 'list' ? 'tile' : 'list';
            localStorage.setItem('currentView', currentView);
            updateView();
        }

        function updateView() {
            const listView = document.getElementById('listView');
            const tileView = document.getElementById('tileView');
            const pageHeader = document.getElementById('pageHeader');
            const container = document.querySelector('.container-fluid');
            const tileControlBar = document.getElementById('tileControlBar');
            const fabButtons = document.querySelectorAll('.fab');
            const tileViewBtnIcon = document.querySelector('#tileViewBtn i');

            // Always show control bar, hide FAB buttons
            tileControlBar.style.display = 'flex';
            fabButtons.forEach(btn => btn.style.display = 'none');

            if (currentView === 'tile') {
                listView.style.display = 'none';
                tileView.style.display = 'grid';
                tileViewBtnIcon.className = 'bi bi-list-ul';
                pageHeader.style.display = 'none';
                container.classList.remove('mt-3');
                container.style.padding = '0';

                renderTileView();
            } else {
                listView.style.display = 'block';
                tileView.style.display = 'none';
                tileViewBtnIcon.className = 'bi bi-grid-3x3-gap';
                pageHeader.style.display = 'block';
                container.classList.add('mt-3');
                container.style.paddingRight = '60px';

                renderTopics();
            }
        }

        function updateViewToggleButton() {
            // Tile view is always enabled now
            const viewToggleBtn = document.getElementById('viewToggle');
            viewToggleBtn.style.display = 'flex';
        }

        function calculateTileGrid(count) {
            if (count === 0) return { rows: 0, cols: 0 };

            // Try to make tiles close to 4:3 ratio (width:height)
            // For a grid: cols/rows  4/3, so cols  1.33 * rows
            // Also: cols * rows >= count

            let bestCols = 1, bestRows = 1;
            let minWaste = Infinity;

            for (let rows = 1; rows <= count; rows++) {
                const cols = Math.ceil(count / rows);
                const ratio = cols / rows;
                const waste = (cols * rows) - count;

                // Prefer ratios close to 4:3 (1.33) with minimal waste
                const ratioScore = Math.abs(ratio - 1.33);
                const score = ratioScore * 10 + waste;

                if (score < minWaste) {
                    minWaste = score;
                    bestRows = rows;
                    bestCols = cols;
                }
            }

            return { rows: bestRows, cols: bestCols };
        }

        function renderTileView() {
            const tileView = document.getElementById('tileView');
            tileView.innerHTML = '';

            // Filter topics to show only those with showInTileView enabled
            const tileTopics = topics.filter(topic => topic.showInTileView !== false);

            const grid = calculateTileGrid(tileTopics.length);

            // Set grid layout
            tileView.style.display = 'grid';
            tileView.style.gridTemplateColumns = `repeat(${grid.cols}, 1fr)`;
            tileView.style.gridTemplateRows = `repeat(${grid.rows}, 1fr)`;

            tileTopics.forEach((topic) => {
                // Find original index in topics array
                const originalIndex = topics.indexOf(topic);

                let displayText, backgroundColor, textColor;

                // Special handling for timer function
                if (topic.functionType === 'timer') {
                    // Check if there's a matching payload value first (for both numeric and non-numeric)
                    const currentPayloadValue = topic.payloadValues && topic.payloadValues.find(pv => pv.value === topic.currentPayload);

                    if (currentPayloadValue) {
                        // Use payload value settings if available
                        displayText = currentPayloadValue.display;
                        backgroundColor = currentPayloadValue.backgroundColor;
                        textColor = currentPayloadValue.textColor;
                    } else {
                        const seconds = parseInt(topic.currentPayload);
                        if (!isNaN(seconds)) {
                            // Format time display
                            displayText = formatTimerDisplay(seconds);

                            // Use timer colors
                            if (seconds >= 0) {
                                backgroundColor = topic.timerCountdownBg || '#007bff';
                                textColor = topic.timerCountdownFg || '#ffffff';
                            } else {
                                backgroundColor = topic.timerOvertimeBg || '#ff0000';
                                textColor = topic.timerOvertimeFg || '#ffffff';
                            }
                        } else {
                            displayText = topic.currentPayload || '';
                            backgroundColor = '#ffffff';
                            textColor = '#000000';
                        }
                    }
                } else {
                    const currentPayloadValue = topic.payloadValues.find(pv => pv.value === topic.currentPayload);
                    displayText = currentPayloadValue ? currentPayloadValue.display : (topic.currentPayload || '');
                    backgroundColor = currentPayloadValue ? currentPayloadValue.backgroundColor : '#ffffff';
                    textColor = currentPayloadValue ? currentPayloadValue.textColor : '#000000';
                }

                const tile = document.createElement('div');
                tile.className = 'tile';
                tile.dataset.index = originalIndex;
                tile.style.backgroundColor = backgroundColor;
                tile.style.color = textColor;

                tile.innerHTML = `
                    <div class="tile-label">${topic.label}</div>
                    <div class="tile-display">${displayText}</div>
                `;

                tile.addEventListener('click', function() {
                    publishNextValue(originalIndex);
                });

                tileView.appendChild(tile);
            });
        }

        function publishNextValue(topicIndex) {
            const topic = topics[topicIndex];
            if (!topic || !mqttClient || !mqttClient.connected) return;

            const values = topic.payloadValues.map(pv => pv.value);
            if (values.length === 0) return;

            // Find current value index
            let currentIndex = values.indexOf(topic.currentPayload);

            // Get next value (cycle to first if at end)
            const nextIndex = (currentIndex + 1) % values.length;
            const nextValue = values[nextIndex];

            // Publish with retain
            mqttClient.publish(topic.name, nextValue, { retain: true });
            console.log(`Tile clicked: ${topic.name} = ${nextValue}`);

            // Update display
            topic.currentPayload = nextValue;
            saveTopics();

            if (currentView === 'tile') {
                renderTileView();
            } else {
                renderTopics();
            }
        }

        // Schedule checker
        let scheduleInterval = null;

        function startScheduleChecker() {
            if (scheduleInterval) return;

            // Check schedules every minute
            scheduleInterval = setInterval(checkSchedules, 60000);
            // Also check immediately
            checkSchedules();
        }

        function checkSchedules() {
            const now = new Date();
            const currentDay = now.getDay(); // 0=Sunday, 1=Monday, ..., 6=Saturday
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

            topics.forEach(topic => {
                if (topic.functionType !== 'schedule' || !topic.functionEnabled || !topic.schedules) {
                    return;
                }

                topic.schedules.forEach(schedule => {
                    // Check if schedule is enabled
                    if (schedule.enabled === false) {
                        return;
                    }

                    // Check if current day matches any scheduled day
                    if (!schedule.days || !schedule.days.includes(currentDay)) {
                        return;
                    }

                    // Check if current time matches schedule time
                    if (schedule.time === currentTime) {
                        // Check if we've already published this minute (prevent duplicates)
                        const scheduleKey = `${topic.name}_${schedule.time}_${currentDay}`;
                        const lastRun = localStorage.getItem(`schedule_${scheduleKey}`);
                        const currentMinute = `${now.getFullYear()}-${now.getMonth()}-${now.getDate()}_${currentTime}`;

                        if (lastRun !== currentMinute && mqttClient && mqttClient.connected) {
                            // Publish payload with retain flag
                            mqttClient.publish(topic.name, schedule.payload, { retain: true });
                            console.log(`Schedule triggered: ${topic.name} = ${schedule.payload} (${schedule.time} on day ${currentDay})`);

                            // Update current payload display
                            topic.currentPayload = schedule.payload;
                            saveTopics();
                            renderTopics();

                            // Mark as run for this minute
                            localStorage.setItem(`schedule_${scheduleKey}`, currentMinute);
                        }
                    }
                });
            });
        }
    </script>
</body>
</html>